<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>üé¥ KoolBox JS on Vercel</title>
  <style>
    body { font-family:sans-serif; max-width:600px; margin:2rem auto; }
    textarea { width:100%; font-size:1rem; }
    button { padding:.5em 1em; font-size:1rem; }
    img { max-width:100%; margin-top:1em; }
    #loading { display:none; }
  </style>
</head>
<body>
  <h1>üé¥ KoolBox JS</h1>
  <textarea id="q" rows="4" placeholder="How can I improve my focus today?"></textarea>
  <p><button id="ask">üó£Ô∏è Ask KoolBox</button></p>
  <div id="loading">‚è≥ Thinking‚Ä¶</div>

  <div id="card" style="display:none;">
    <h2 id="card-title"></h2>
    <p id="card-content"></p>
  </div>
  <hr>
  <h3 id="takeaway-title" style="display:none;">üé¥ Takeaway</h3>
  <p id="takeaway"></p>
  <h3 id="answer-title" style="display:none;">üí° Answer</h3>
  <p id="answer"></p>
  <div id="img-container"></div>

  <script>
    // Correctly grab the button by id:
    document.getElementById("ask").onclick = async () => {
      const q = document.getElementById("q").value.trim();
      if (!q) return alert("Please type a question!");

      document.getElementById("loading").style.display = "block";

      let res;
      try {
        // NOTE: use /api/ask, not /ask
        res = await fetch("/api/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: q })
        });
      } catch (err) {
        document.getElementById("loading").style.display = "none";
        return alert("Network error: " + err.message);
      }

      document.getElementById("loading").style.display = "none";

      // Read the raw text once:
      const text = await res.text();

      if (!res.ok) {
        // Try to parse JSON out of the text, fallback to raw text:
        let msg;
        try {
          msg = JSON.parse(text).error;
        } catch {
          msg = text;
        }
        return alert("Error: " + msg);
      }

      // Now that it's OK, parse JSON:
      let payload;
      try {
        payload = JSON.parse(text);
      } catch (e) {
        return alert("Invalid JSON response");
      }

      const { card, takeaway, answer, image } = payload;

      // Render the card + texts:
      document.getElementById("card-title").innerText   = card.title;
      document.getElementById("card-content").innerText = card.content;
      document.getElementById("card").style.display      = "block";

      document.getElementById("takeaway-title").style.display = "block";
      document.getElementById("takeaway").innerText          = takeaway;

      document.getElementById("answer-title").style.display = "block";
      document.getElementById("answer").innerText          = answer;

      // Render the image if we got one:
      const imgDiv = document.getElementById("img-container");
      imgDiv.innerHTML = "";
      if (image) {
        const img = new Image();
        img.src = "data:image/png;base64," + image;
        img.alt = "Visual representation";
        imgDiv.appendChild(img);
      }
    };
  </script>
</body>
</html>
